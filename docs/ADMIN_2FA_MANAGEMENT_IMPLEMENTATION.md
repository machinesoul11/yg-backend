# Admin 2FA Management Implementation

## Overview

Complete implementation of administrative tools for managing two-factor authentication across the YES GODDESS platform. This feature provides admins with comprehensive controls to view, manage, and enforce 2FA policies for all users.

**Implementation Date:** October 19, 2025  
**Status:** âœ… Complete  
**API Version:** 1.0

---

## Database Schema

### New Models

#### `TwoFactorPolicy`
Defines 2FA enforcement rules for each user role.

```prisma
model TwoFactorPolicy {
  id                    String   @id @default(cuid())
  role                  UserRole @unique
  enforcementType       TwoFactorEnforcementType @default(OPTIONAL)
  gracePeriodDays       Int      @default(30)
  enforcementStartDate  DateTime?
  allowedMethods        TwoFactorMethod[]
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  createdBy             String?
  updatedBy             String?
}
```

#### `AdminEmergencyCode`
Emergency access codes generated by admins for locked-out users.

```prisma
model AdminEmergencyCode {
  id            String    @id @default(cuid())
  userId        String
  codeHash      String
  generatedBy   String
  reason        String?
  used          Boolean   @default(false)
  usedAt        DateTime?
  expiresAt     DateTime
  ipAddress     String?
  userAgent     String?
  createdAt     DateTime  @default(now())
}
```

#### `TwoFactorSecurityLog`
Comprehensive audit log for all 2FA-related events.

```prisma
model TwoFactorSecurityLog {
  id              String   @id @default(cuid())
  userId          String
  adminId         String?
  eventType       String
  action          String
  success         Boolean  @default(true)
  failureReason   String?
  metadata        Json?
  ipAddress       String?
  userAgent       String?
  deviceInfo      String?
  locationCountry String?
  locationCity    String?
  createdAt       DateTime @default(now())
}
```

### User Model Extensions

Added fields to the `User` model to support 2FA policies:

```prisma
two_factor_required       Boolean   @default(false)
two_factor_grace_period_ends DateTime?
two_factor_last_reset_by  String?
two_factor_last_reset_at  DateTime?
```

### New Enums

```prisma
enum TwoFactorEnforcementType {
  OPTIONAL
  MANDATORY
  ROLE_BASED
}
```

---

## API Endpoints

All endpoints require `ADMIN` role authorization.

### 1. Get All Users 2FA Status

**Endpoint:** `GET /api/admin/users/2fa`

Retrieves 2FA status for all users with pagination and filtering.

#### Query Parameters
- `page` (number, optional): Page number (default: 1)
- `limit` (number, optional): Items per page (default: 50)
- `role` (UserRole, optional): Filter by user role
- `twoFactorEnabled` (boolean, optional): Filter by 2FA enabled status
- `twoFactorRequired` (boolean, optional): Filter by 2FA required status
- `search` (string, optional): Search by email or name

#### Response (200 OK)
```json
{
  "users": [
    {
      "id": "user123",
      "email": "user@example.com",
      "name": "John Doe",
      "role": "CREATOR",
      "two_factor_enabled": true,
      "two_factor_verified_at": "2025-10-15T10:30:00.000Z",
      "two_factor_required": false,
      "two_factor_grace_period_ends": null,
      "preferred_2fa_method": "AUTHENTICATOR",
      "phone_verified": false,
      "backupCodesRemaining": 8,
      "lastLoginAt": "2025-10-19T08:15:00.000Z",
      "isLocked": false,
      "createdAt": "2025-01-10T12:00:00.000Z"
    }
  ],
  "total": 150,
  "page": 1,
  "limit": 50
}
```

---

### 2. Get User 2FA Details

**Endpoint:** `GET /api/admin/users/2fa/[userId]`

Retrieves detailed 2FA information for a specific user.

#### Response (200 OK)
```json
{
  "id": "user123",
  "email": "user@example.com",
  "name": "John Doe",
  "role": "CREATOR",
  "two_factor_enabled": true,
  "two_factor_verified_at": "2025-10-15T10:30:00.000Z",
  "two_factor_required": false,
  "two_factor_grace_period_ends": null,
  "two_factor_last_reset_at": null,
  "two_factor_last_reset_by": null,
  "preferred_2fa_method": "AUTHENTICATOR",
  "phone_verified": false,
  "backupCodesRemaining": 8,
  "emergencyCodesActive": 0,
  "lastLoginAt": "2025-10-19T08:15:00.000Z",
  "isLocked": false,
  "createdAt": "2025-01-10T12:00:00.000Z",
  "recentSecurityEvents": [
    {
      "eventType": "TOTP_VERIFICATION_SUCCESS",
      "action": "VERIFY_TOTP",
      "success": true,
      "createdAt": "2025-10-19T08:15:00.000Z",
      "ipAddress": "192.168.1.1"
    }
  ],
  "loginAttempts": [
    {
      "success": true,
      "ipAddress": "192.168.1.1",
      "timestamp": "2025-10-19T08:15:00.000Z",
      "failureReason": null
    }
  ]
}
```

---

### 3. Reset User 2FA

**Endpoint:** `POST /api/admin/users/2fa/[userId]/reset`

Force resets a user's 2FA configuration. Requires admin reason.

#### Request Body
```json
{
  "reason": "User lost access to authenticator app and backup codes"
}
```

#### Response (200 OK)
```json
{
  "success": true,
  "message": "User 2FA has been reset successfully"
}
```

#### Security Features
- Admins cannot reset their own 2FA
- Clears all 2FA settings (secret, phone, backup codes, emergency codes)
- Logs action comprehensively
- Sends notification email to affected user

---

### 4. Generate Emergency Codes

**Endpoint:** `POST /api/admin/users/2fa/[userId]/emergency-codes`

Generates emergency access codes for a locked-out user.

#### Request Body
```json
{
  "reason": "User unable to access authenticator app due to lost device"
}
```

#### Response (200 OK)
```json
{
  "success": true,
  "data": {
    "codes": [
      "A1B2C3D4E5F6G7H8",
      "I9J0K1L2M3N4O5P6",
      "Q7R8S9T0U1V2W3X4",
      "Y5Z6A7B8C9D0E1F2",
      "G3H4I5J6K7L8M9N0"
    ],
    "expiresAt": "2025-10-21T10:00:00.000Z",
    "warning": "These codes are shown only once. Provide them to the user securely."
  }
}
```

#### Security Features
- Codes are hashed with bcrypt (12 rounds) before storage
- Codes expire after 48 hours
- Single-use only
- Comprehensive logging of generation and usage

---

### 5. Get Security Logs

**Endpoint:** `GET /api/admin/users/2fa/logs`

Retrieves 2FA security audit logs with filtering.

#### Query Parameters
- `page` (number, optional): Page number
- `limit` (number, optional): Items per page (default: 100)
- `userId` (string, optional): Filter by user ID
- `adminId` (string, optional): Filter by admin ID
- `eventType` (string, optional): Filter by event type
- `startDate` (ISO string, optional): Start date for date range
- `endDate` (ISO string, optional): End date for date range

#### Response (200 OK)
```json
{
  "logs": [
    {
      "id": "log123",
      "userId": "user123",
      "adminId": "admin456",
      "eventType": "ADMIN_2FA_RESET",
      "action": "FORCE_RESET",
      "success": true,
      "failureReason": null,
      "metadata": {
        "reason": "User lost device",
        "resetBy": "admin456"
      },
      "ipAddress": "192.168.1.100",
      "userAgent": "Mozilla/5.0...",
      "deviceInfo": null,
      "locationCountry": "US",
      "locationCity": "New York",
      "createdAt": "2025-10-19T10:00:00.000Z"
    }
  ],
  "total": 500,
  "page": 1,
  "limit": 100
}
```

---

### 6. Export Security Logs

**Endpoint:** `GET /api/admin/users/2fa/logs/export`

Exports security logs as CSV or JSON.

#### Query Parameters
- `format` (string, optional): 'csv' or 'json' (default: 'csv')
- `userId` (string, optional): Filter by user ID
- `adminId` (string, optional): Filter by admin ID
- `eventType` (string, optional): Filter by event type
- `startDate` (ISO string, optional): Start date
- `endDate` (ISO string, optional): End date

#### Response
Returns file download with appropriate Content-Type and Content-Disposition headers.

**CSV Format:**
```csv
ID,User ID,Admin ID,Event Type,Action,Success,Failure Reason,IP Address,Location,Created At
log123,user123,admin456,ADMIN_2FA_RESET,FORCE_RESET,Yes,,192.168.1.100,New York US,2025-10-19T10:00:00.000Z
```

---

### 7. Manage 2FA Policies

**Endpoint:** `GET /api/admin/users/2fa/policies`  
**Endpoint:** `POST /api/admin/users/2fa/policies`

Get all policies or create/update a policy.

#### GET Response (200 OK)
```json
{
  "success": true,
  "data": [
    {
      "role": "ADMIN",
      "enforcementType": "MANDATORY",
      "gracePeriodDays": 7,
      "enforcementStartDate": null,
      "allowedMethods": ["AUTHENTICATOR", "SMS"]
    },
    {
      "role": "CREATOR",
      "enforcementType": "OPTIONAL",
      "gracePeriodDays": 30,
      "enforcementStartDate": null,
      "allowedMethods": []
    }
  ]
}
```

#### POST Request Body
```json
{
  "role": "ADMIN",
  "enforcementType": "MANDATORY",
  "gracePeriodDays": 7,
  "enforcementStartDate": null,
  "allowedMethods": ["AUTHENTICATOR", "SMS"]
}
```

#### POST Response (200 OK)
```json
{
  "success": true,
  "message": "2FA policy for ADMIN role has been updated successfully"
}
```

---

### 8. Get Policy by Role

**Endpoint:** `GET /api/admin/users/2fa/policies/[role]`

Retrieves 2FA policy for a specific role.

#### Response (200 OK)
```json
{
  "success": true,
  "data": {
    "role": "ADMIN",
    "enforcementType": "MANDATORY",
    "gracePeriodDays": 7,
    "enforcementStartDate": null,
    "allowedMethods": ["AUTHENTICATOR", "SMS"]
  }
}
```

---

### 9. Get Non-Compliant Users

**Endpoint:** `GET /api/admin/users/2fa/non-compliant`

Retrieves users who haven't enabled 2FA but are required to.

#### Query Parameters
- `role` (UserRole, optional): Filter by role

#### Response (200 OK)
```json
{
  "success": true,
  "data": [
    {
      "id": "user456",
      "email": "admin@example.com",
      "name": "Jane Admin",
      "role": "ADMIN",
      "gracePeriodEnds": "2025-10-26T00:00:00.000Z",
      "daysRemaining": 7
    }
  ],
  "total": 5
}
```

---

## Service Layer

### Admin2FAManagementService

Main service class handling all admin 2FA operations.

**File:** `src/lib/services/admin-2fa-management.service.ts`

#### Key Methods

##### `getAllUsers2FAStatus(options)`
Retrieves paginated list of all users with their 2FA status.

##### `getUser2FADetails(userId)`
Gets comprehensive 2FA information for a specific user.

##### `resetUser2FA(userId, adminId, reason, context)`
Force resets a user's 2FA configuration.

##### `generateEmergencyCodes(userId, adminId, reason, context)`
Generates emergency access codes for locked-out users.

##### `verifyEmergencyCode(userId, code)`
Verifies and uses an emergency code during login.

##### `getSecurityLogs(options)`
Retrieves filtered and paginated security logs.

##### `exportSecurityLogs(options)`
Exports security logs to CSV or JSON format.

##### `set2FAPolicy(config, adminId, context)`
Creates or updates 2FA policy for a role.

##### `get2FAPolicy(role)`
Retrieves 2FA policy for a specific role.

##### `getAll2FAPolicies()`
Gets all configured 2FA policies.

##### `checkUserPolicyCompliance(userId)`
Checks if a user complies with their role's 2FA policy.

##### `getNonCompliantUsers(role?)`
Gets list of users who haven't enabled required 2FA.

---

## Email Notifications

### 2FA Admin Reset Email

**Template:** `2fa-admin-reset`  
**File:** `emails/templates/TwoFactorAdminReset.tsx`

Sent when an admin resets a user's 2FA configuration.

**Props:**
```typescript
interface TwoFactorAdminResetProps {
  userName: string;
  resetReason: string;
  resetDate: string;
  setupUrl: string;
}
```

---

## Authorization

All endpoints require:
1. Valid authentication session
2. `ADMIN` role
3. Active (non-deleted) admin account

Authorization is enforced at the endpoint level:
```typescript
const session = await getServerSession(authOptions);

if (!session?.user || session.user.role !== 'ADMIN') {
  return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
}
```

---

## Security Features

### Emergency Code Security
- Codes are cryptographically random (16 hex characters)
- Hashed with bcrypt (12 rounds) before storage
- 48-hour expiration
- Single-use only
- Comprehensive logging

### Admin Action Logging
All admin actions are logged with:
- Admin ID
- User ID
- Action type
- Reason (when provided)
- IP address
- User agent
- Timestamp
- Success/failure status

### Self-Service Restrictions
- Admins cannot reset their own 2FA
- Policy changes are logged
- All actions require explicit reasons

### Audit Trail
- Immutable security logs
- Comprehensive metadata
- IP and location tracking
- Device fingerprinting

---

## Policy Enforcement

### Enforcement Types

1. **OPTIONAL** - Users can choose to enable 2FA
2. **MANDATORY** - All users of the role must enable 2FA
3. **ROLE_BASED** - Enforcement based on specific role

### Grace Period

When a policy is set to MANDATORY:
1. Users are notified they must enable 2FA
2. Grace period countdown begins
3. During grace period, warnings are shown but access is allowed
4. After grace period expires, users are locked out until they enable 2FA

### Compliance Checking

The system automatically checks policy compliance during login:
```typescript
const compliance = await admin2FAService.checkUserPolicyCompliance(userId);

if (!compliance.compliant && compliance.daysRemaining === 0) {
  // Lock user out, require 2FA setup
}
```

---

## Integration with Existing 2FA System

### Emergency Code Login Flow

1. User attempts to log in with 2FA enabled
2. User indicates they lost access to 2FA method
3. User enters emergency code provided by admin
4. System verifies code using `verifyEmergencyCode()`
5. Code is marked as used
6. User gains access
7. User is prompted to reconfigure 2FA

### Policy Enforcement Integration

Policies are checked at multiple points:
- During user login
- When accessing sensitive features
- During admin user management
- In user settings dashboard

---

## Error Handling

### Common Error Responses

**401 Unauthorized**
```json
{
  "error": "Unauthorized"
}
```

**403 Forbidden**
```json
{
  "error": "Admins cannot reset their own 2FA. Please contact another administrator."
}
```

**404 Not Found**
```json
{
  "error": "User not found"
}
```

**400 Bad Request**
```json
{
  "error": "Reason is required for 2FA reset"
}
```

---

## Testing Checklist

- [ ] Test admin can view all users' 2FA status
- [ ] Test filtering and pagination work correctly
- [ ] Test admin can view detailed user 2FA information
- [ ] Test admin can reset user 2FA with reason
- [ ] Test admin cannot reset their own 2FA
- [ ] Test emergency code generation works
- [ ] Test emergency codes expire after 48 hours
- [ ] Test emergency codes are single-use
- [ ] Test security logs capture all events
- [ ] Test log export works in CSV and JSON formats
- [ ] Test 2FA policy creation and updates
- [ ] Test mandatory policy enforcement
- [ ] Test grace period functionality
- [ ] Test non-compliant user detection
- [ ] Test email notifications are sent
- [ ] Test audit logging works correctly

---

## Future Enhancements

1. **Approval Workflows**
   - Require second admin approval for sensitive actions
   - Emergency code generation approval queue

2. **Advanced Analytics**
   - 2FA adoption metrics dashboard
   - Security incident trending
   - Compliance reporting

3. **Automated Enforcement**
   - Auto-remind users approaching grace period end
   - Automatic policy application based on rules

4. **Emergency Access**
   - Time-limited emergency access tokens
   - Multi-factor emergency verification

---

## Related Documentation

- [2FA Challenge Endpoints Implementation](./2FA_CHALLENGE_ENDPOINTS_IMPLEMENTATION.md)
- [Authenticator 2FA REST API Implementation](./AUTHENTICATOR_2FA_REST_API_IMPLEMENTATION.md)
- [Frontend Integration: Authentication](./FRONTEND_INTEGRATION_AUTHENTICATION.md)
- [Access Control Integration Guide](./frontend-integration/ACCESS_CONTROL_INTEGRATION_GUIDE.md)

---

## Maintenance Notes

### Database Cleanup

Periodically clean up expired emergency codes:
```sql
DELETE FROM admin_emergency_codes 
WHERE expires_at < NOW() 
AND used = false;
```

### Log Retention

Consider archiving old security logs after 1 year while maintaining compliance requirements.

### Monitoring

Monitor these metrics:
- Emergency code usage rate
- 2FA reset frequency
- Policy compliance rates
- Admin action patterns

---

**Last Updated:** October 19, 2025  
**Author:** Backend Development Team  
**Version:** 1.0.0
